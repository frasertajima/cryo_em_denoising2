!================================================================
! Test Gradient Loss Module
!================================================================
program test_gradient
    use cudafor
    use gradient_loss_module
    implicit none

    integer, parameter :: WIDTH = 64
    integer, parameter :: HEIGHT = 64
    integer, parameter :: BATCH_SIZE = 2

    real(4), device, allocatable :: d_img1(:,:,:,:)
    real(4), device, allocatable :: d_img2(:,:,:,:)
    real(4) :: loss
    integer :: i, j, b

    print *, "========================================"
    print *, "Test Gradient Loss Module"
    print *, "========================================"
    print *, ""

    ! Initialize gradient module
    call init_gradient_loss(WIDTH, HEIGHT, BATCH_SIZE)

    ! Allocate test images
    allocate(d_img1(WIDTH, HEIGHT, 1, BATCH_SIZE))
    allocate(d_img2(WIDTH, HEIGHT, 1, BATCH_SIZE))

    ! Test 1: Identical images (loss should be 0)
    print *, "Test 1: Identical gradient images"
    !$cuf kernel do(3) <<< *, * >>>
    do b = 1, BATCH_SIZE
        do j = 1, HEIGHT
            do i = 1, WIDTH
                d_img1(i, j, 1, b) = real(i) / real(WIDTH)
                d_img2(i, j, 1, b) = real(i) / real(WIDTH)
            end do
        end do
    end do

    call compute_gradient_loss(d_img1, d_img2, BATCH_SIZE, loss)
    print '(A,F10.6)', "  Gradient Loss: ", loss
    if (abs(loss) < 0.001) then
        print *, "  PASS: Loss is near zero for identical gradients"
    else
        print *, "  WARNING: Expected ~0 loss for identical images"
    endif
    print *, ""

    ! Test 2: Sharp edge vs smooth
    print *, "Test 2: Sharp edge vs blurred edge"
    !$cuf kernel do(3) <<< *, * >>>
    do b = 1, BATCH_SIZE
        do j = 1, HEIGHT
            do i = 1, WIDTH
                ! Sharp step edge
                if (i <= WIDTH/2) then
                    d_img1(i, j, 1, b) = 0.0
                else
                    d_img1(i, j, 1, b) = 1.0
                endif
                ! Smooth gradient
                d_img2(i, j, 1, b) = real(i) / real(WIDTH)
            end do
        end do
    end do

    call compute_gradient_loss(d_img1, d_img2, BATCH_SIZE, loss)
    print '(A,F10.6)', "  Gradient Loss: ", loss
    if (loss > 0.1) then
        print *, "  PASS: High loss for different edge types"
    endif
    print *, ""

    ! Test 3: Horizontal vs vertical edges
    print *, "Test 3: Horizontal vs vertical gradient"
    !$cuf kernel do(3) <<< *, * >>>
    do b = 1, BATCH_SIZE
        do j = 1, HEIGHT
            do i = 1, WIDTH
                d_img1(i, j, 1, b) = real(i) / real(WIDTH)  ! Horizontal gradient
                d_img2(i, j, 1, b) = real(j) / real(HEIGHT) ! Vertical gradient
            end do
        end do
    end do

    call compute_gradient_loss(d_img1, d_img2, BATCH_SIZE, loss)
    print '(A,F10.6)', "  Gradient Loss: ", loss
    if (loss > 0.01) then
        print *, "  PASS: Different gradients produce loss"
    endif
    print *, ""

    ! Test 4: Flat images (no gradients)
    print *, "Test 4: Flat images (no edges)"
    !$cuf kernel do(3) <<< *, * >>>
    do b = 1, BATCH_SIZE
        do j = 1, HEIGHT
            do i = 1, WIDTH
                d_img1(i, j, 1, b) = 0.5
                d_img2(i, j, 1, b) = 0.5
            end do
        end do
    end do

    call compute_gradient_loss(d_img1, d_img2, BATCH_SIZE, loss)
    print '(A,F10.6)', "  Gradient Loss: ", loss
    if (abs(loss) < 0.001) then
        print *, "  PASS: Zero loss for flat images"
    endif
    print *, ""

    ! Cleanup
    deallocate(d_img1, d_img2)
    call destroy_gradient_loss()

    print *, "========================================"
    print *, "All tests completed!"
    print *, "========================================"

end program test_gradient
